@if (isVisible()) {
<div class="modal-backdrop" (click)="close()">
    <div class="settings-modal" (click)="$event.stopPropagation()">
        <div class="modal-header">
            <h2>Configure Report</h2>
            <button class="btn-icon-small" (click)="close()">
                <span class="material-symbols-outlined">close</span>
            </button>
        </div>

        <div class="modal-content">
            <p class="modal-description">
                Configure which variants and reads to include in the report for <strong>{{ jobName() }}</strong>.
            </p>

            <div class="variants-config-list">
                @if (markedVariants().length === 0) {
                <div class="empty-state">
                    <span class="material-symbols-outlined large-icon">bookmark_border</span>
                    <p>No variants marked for report.</p>
                    <p class="sub-text">Go back and click the bookmark icon on variants to include them.</p>
                </div>
                }

                @for (variant of markedVariants(); track variant.position; let i = $index) {
                <div class="variant-config-item">
                    <div class="variant-header">
                        <div class="variant-info">
                            <span class="variant-pos-tag">Pos: {{ variant.position }}</span>
                            <span class="variant-change">{{ variant.ref }} / {{ variant.alt }}</span>
                        </div>
                        <div class="variant-actions">
                            <!-- Reference Toggle -->
                            <label class="checkbox-label">
                                <input type="checkbox" [checked]="configItems()[i]?.includeReference"
                                    (change)="updateItem(i, { includeReference: !configItems()[i]?.includeReference })">
                                <span>Include Reference</span>
                            </label>
                        </div>
                    </div>

                    <div class="variant-body">
                        <!-- Comments -->
                        <div class="form-group">
                            <label class="form-label">Variant Analysis Comments</label>
                            <textarea rows="2" class="form-input" [ngModel]="configItems()[i]?.comments"
                                (ngModelChange)="updateItem(i, { comments: $event })"
                                placeholder="Add specific notes for this variant..."></textarea>
                        </div>

                        <!-- Read Selection -->
                        <div class="reads-selection">
                            <label class="form-label">Select Reads to Include</label>
                            <div class="reads-grid">
                                @for (read of getAvailableReads(variant.position); track read.id) {
                                <div class="read-card" [class.selected]="isReadSelected(i, read.id)"
                                    (click)="toggleReadSelection(i, read.id)">
                                    <div class="selection-indicator">
                                        <span class="material-symbols-outlined">
                                            {{ isReadSelected(i, read.id) ? 'check_circle' : 'radio_button_unchecked' }}
                                        </span>
                                    </div>
                                    <div class="read-details">
                                        <span class="read-name">{{ read.name }}</span>
                                        <span class="patient-id">{{ read.patientName }}</span>
                                    </div>
                                </div>
                                }
                            </div>
                        </div>
                    </div>
                </div>
                }
            </div>
        </div>

        <div class="modal-footer">
            <button class="btn-outline" (click)="close()">Cancel</button>
            <button class="btn-solid" (click)="confirm()" [disabled]="markedVariants().length === 0">
                <span class="material-symbols-outlined">picture_as_pdf</span>
                Generate Report
            </button>
        </div>
    </div>
</div>
}